<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Image Fallback System Test</title>
    <link rel="stylesheet" href="css/image-enhancements.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .test-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        .test-item h4 {
            margin: 0;
            padding: 10px;
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
        }
        .test-image-container {
            height: 200px;
            position: relative;
        }
        .controls {
            padding: 15px;
            background: #f8f9fa;
            border-top: 1px solid #ddd;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn.danger {
            background: #dc3545;
        }
        .btn.danger:hover {
            background: #c82333;
        }
        .stats {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>Enhanced Image Fallback System Test</h1>
    <p>This page demonstrates the three-tier fallback system with modern image formats (WebP/JPEG) and error handling.</p>

    <div class="test-section">
        <h2>Working Images (Stock → Optimized → WebP)</h2>
        <div class="test-grid">
            <div class="test-item">
                <h4>Hero Image - Working</h4>
                <div class="test-image-container" id="hero-working"></div>
                <div class="controls">
                    <button class="btn" onclick="createWorkingImage('hero-working', 'hero', 'hero-main-plumber')">Create Working Image</button>
                </div>
            </div>
            
            <div class="test-item">
                <h4>Service Image - Working</h4>
                <div class="test-image-container" id="service-working"></div>
                <div class="controls">
                    <button class="btn" onclick="createWorkingImage('service-working', 'services', 'service-bathroom-plumbing')">Create Working Image</button>
                </div>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h2>Fallback System Test (Non-existent Images)</h2>
        <div class="test-grid">
            <div class="test-item">
                <h4>Primary Fails → Secondary Fallback</h4>
                <div class="test-image-container" id="fallback-secondary"></div>
                <div class="controls">
                    <button class="btn" onclick="createFallbackTest('fallback-secondary', 'hero', 'non-existent-image')">Test Secondary Fallback</button>
                    <button class="btn danger" onclick="triggerImageError('fallback-secondary')">Trigger Error</button>
                </div>
            </div>
            
            <div class="test-item">
                <h4>All Images Fail → CSS Placeholder</h4>
                <div class="test-image-container" id="fallback-tertiary"></div>
                <div class="controls">
                    <button class="btn" onclick="createPlaceholderTest('fallback-tertiary', 'services')">Test CSS Placeholder</button>
                </div>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h2>WebP Support & Format Detection</h2>
        <div id="webp-support-info"></div>
        <div class="test-grid">
            <div class="test-item">
                <h4>Picture Element with Multiple Sources</h4>
                <div class="test-image-container" id="picture-element"></div>
                <div class="controls">
                    <button class="btn" onclick="createPictureElement('picture-element')">Create Picture Element</button>
                    <button class="btn" onclick="inspectPictureElement('picture-element')">Inspect Sources</button>
                </div>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h2>Fallback Statistics</h2>
        <div class="controls">
            <button class="btn" onclick="showFallbackStats()">Show Statistics</button>
            <button class="btn" onclick="resetFallbackStats()">Reset Statistics</button>
            <button class="btn" onclick="runFallbackSystemTest()">Run System Test</button>
        </div>
        <div id="stats-display" class="stats"></div>
    </div>

    <script src="js/image-enhancements.js"></script>
    <script>
        // Wait for the image enhancement manager to initialize
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                displayWebPSupport();
            }, 1000);
        });

        function displayWebPSupport() {
            const webpSupported = window.imageEnhancementManager?.checkWebPSupport();
            const info = document.getElementById('webp-support-info');
            info.innerHTML = `
                <p><strong>WebP Support:</strong> ${webpSupported ? '✅ Supported' : '❌ Not Supported'}</p>
                <p><strong>Browser:</strong> ${navigator.userAgent.split(' ')[0]}</p>
            `;
        }

        function createWorkingImage(containerId, category, imageName) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            if (window.imageEnhancementManager) {
                const picture = window.imageEnhancementManager.createPictureElement(category, imageName, 'test-image');
                if (picture) {
                    container.appendChild(picture);
                } else {
                    container.innerHTML = '<p>Failed to create picture element</p>';
                }
            } else {
                container.innerHTML = '<p>Image Enhancement Manager not loaded</p>';
            }
        }

        function createFallbackTest(containerId, category, imageName) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            // Create a test image with non-existent source
            const img = document.createElement('img');
            img.src = 'images/non-existent-primary.jpg';
            img.alt = 'Test fallback image';
            img.className = 'enhanced-image';
            img.dataset.fallbackSrc = 'images/hero-bg.jpg'; // This should exist
            img.dataset.category = category;
            img.dataset.imageName = imageName;
            
            // Add error handling
            img.addEventListener('error', function() {
                if (window.imageEnhancementManager) {
                    window.imageEnhancementManager.handleEnhancedImageError(this);
                }
            });
            
            container.appendChild(img);
        }

        function createPlaceholderTest(containerId, category) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            container.className = 'test-image-container image-placeholder';
            
            if (window.imageEnhancementManager) {
                window.imageEnhancementManager.createPlaceholderContent(container, category);
            }
        }

        function triggerImageError(containerId) {
            const container = document.getElementById(containerId);
            const img = container.querySelector('img');
            if (img && window.imageEnhancementManager) {
                window.imageEnhancementManager.handleEnhancedImageError(img);
            }
        }

        function createPictureElement(containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            if (window.imageEnhancementManager) {
                const picture = window.imageEnhancementManager.createPictureElement('hero', 'hero-main-plumber', 'test-picture');
                if (picture) {
                    container.appendChild(picture);
                } else {
                    container.innerHTML = '<p>Failed to create picture element</p>';
                }
            }
        }

        function inspectPictureElement(containerId) {
            const container = document.getElementById(containerId);
            const picture = container.querySelector('picture');
            
            if (picture) {
                const sources = picture.querySelectorAll('source');
                const img = picture.querySelector('img');
                
                let info = `<strong>Picture Element Inspection:</strong><br>`;
                info += `Sources: ${sources.length}<br>`;
                
                sources.forEach((source, index) => {
                    info += `Source ${index + 1}: ${source.type} - ${source.srcset}<br>`;
                });
                
                if (img) {
                    info += `Fallback img: ${img.src}<br>`;
                    info += `Alt text: ${img.alt}<br>`;
                    info += `Loading: ${img.loading}<br>`;
                }
                
                alert(info);
            } else {
                alert('No picture element found');
            }
        }

        function showFallbackStats() {
            if (window.imageEnhancementManager) {
                const stats = window.imageEnhancementManager.getFallbackStats();
                const display = document.getElementById('stats-display');
                display.innerHTML = '<strong>Fallback Statistics:</strong><br>' + JSON.stringify(stats, null, 2);
            }
        }

        function resetFallbackStats() {
            if (window.imageEnhancementManager) {
                window.imageEnhancementManager.resetFallbackStats();
                document.getElementById('stats-display').innerHTML = 'Statistics reset.';
            }
        }

        function runFallbackSystemTest() {
            if (window.imageEnhancementManager) {
                const testPicture = window.imageEnhancementManager.testFallbackSystem();
                document.getElementById('stats-display').innerHTML = 'System test running... Check console and top-right corner for test container.';
            }
        }
    </script>
</body>
</html>